class S extends Error{response;request;options;constructor(t,s,o){const r=t.status||t.status===0?t.status:"",a=t.statusText||"",i=`${r} ${a}`.trim(),n=i?`status code ${i}`:"an unknown error";super(`Request failed with ${n}: ${s.method} ${s.url}`),this.name="HTTPError",this.response=t,this.request=s,this.options=o}}class P extends Error{request;constructor(t){super(`Request timed out: ${t.method} ${t.url}`),this.name="TimeoutError",this.request=t}}const d=e=>e!==null&&typeof e=="object",f=(...e)=>{for(const t of e)if((!d(t)||Array.isArray(t))&&t!==void 0)throw new TypeError("The `options` argument must be an object");return _({},...e)},I=(e={},t={})=>{const s=new globalThis.Headers(e),o=t instanceof globalThis.Headers,r=new globalThis.Headers(t);for(const[a,i]of r.entries())o&&i==="undefined"||i===void 0?s.delete(a):s.set(a,i);return s};function m(e,t,s){return Object.hasOwn(t,s)&&t[s]===void 0?[]:_(e[s]??[],t[s]??[])}const k=(e={},t={})=>({beforeRequest:m(e,t,"beforeRequest"),beforeRetry:m(e,t,"beforeRetry"),afterResponse:m(e,t,"afterResponse"),beforeError:m(e,t,"beforeError")}),_=(...e)=>{let t={},s={},o={};for(const r of e)if(Array.isArray(r))Array.isArray(t)||(t=[]),t=[...t,...r];else if(d(r)){for(let[a,i]of Object.entries(r))d(i)&&a in t&&(i=_(t[a],i)),t={...t,[a]:i};d(r.hooks)&&(o=k(o,r.hooks),t.hooks=o),d(r.headers)&&(s=I(s,r.headers),t.headers=s)}return t},C=(()=>{let e=!1,t=!1;const s=typeof globalThis.ReadableStream=="function",o=typeof globalThis.Request=="function";if(s&&o)try{t=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("Content-Type")}catch(r){if(r instanceof Error&&r.message==="unsupported BodyInit type")return!1;throw r}return e&&!t})(),x=typeof globalThis.AbortController=="function",E=typeof globalThis.ReadableStream=="function",N=typeof globalThis.FormData=="function",v=["get","post","put","patch","head","delete"],L={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*"},b=2147483647,$=Symbol("stop"),U={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,fetch:!0},D={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,dispatcher:!0,duplex:!0,priority:!0},O=e=>v.includes(e)?e.toUpperCase():e,j=["get","put","head","delete","options","trace"],H=[408,413,429,500,502,503,504],V=[413,429,503],T={limit:2,methods:j,statusCodes:H,afterStatusCodes:V,maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:e=>.3*2**(e-1)*1e3},M=(e={})=>{if(typeof e=="number")return{...T,limit:e};if(e.methods&&!Array.isArray(e.methods))throw new Error("retry.methods must be an array");if(e.statusCodes&&!Array.isArray(e.statusCodes))throw new Error("retry.statusCodes must be an array");return{...T,...e}};async function B(e,t,s,o){return new Promise((r,a)=>{const i=setTimeout(()=>{s&&s.abort(),a(new P(e))},o.timeout);o.fetch(e,t).then(r).catch(a).then(()=>{clearTimeout(i)})})}async function F(e,{signal:t}){return new Promise((s,o)=>{t&&(t.throwIfAborted(),t.addEventListener("abort",r,{once:!0}));function r(){clearTimeout(a),o(t.reason)}const a=setTimeout(()=>{t?.removeEventListener("abort",r),s()},e)})}const J=(e,t)=>{const s={};for(const o in t)!(o in D)&&!(o in U)&&!(o in e)&&(s[o]=t[o]);return s};class y{static create(t,s){const o=new y(t,s),r=async()=>{if(typeof o._options.timeout=="number"&&o._options.timeout>b)throw new RangeError(`The \`timeout\` option cannot be greater than ${b}`);await Promise.resolve();let n=await o._fetch();for(const u of o._options.hooks.afterResponse){const c=await u(o.request,o._options,o._decorateResponse(n.clone()));c instanceof globalThis.Response&&(n=c)}if(o._decorateResponse(n),!n.ok&&o._options.throwHttpErrors){let u=new S(n,o.request,o._options);for(const c of o._options.hooks.beforeError)u=await c(u);throw u}if(o._options.onDownloadProgress){if(typeof o._options.onDownloadProgress!="function")throw new TypeError("The `onDownloadProgress` option must be a function");if(!E)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return o._stream(n.clone(),o._options.onDownloadProgress)}return n},i=o._options.retry.methods.includes(o.request.method.toLowerCase())?o._retry(r):r();for(const[n,u]of Object.entries(L))i[n]=async()=>{o.request.headers.set("accept",o.request.headers.get("accept")||u);const c=await i;if(n==="json"){if(c.status===204||(await c.clone().arrayBuffer()).byteLength===0)return"";if(s.parseJson)return s.parseJson(await c.text())}return c[n]()};return i}request;abortController;_retryCount=0;_input;_options;constructor(t,s={}){if(this._input=t,this._options={...s,headers:I(this._input.headers,s.headers),hooks:k({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},s.hooks),method:O(s.method??this._input.method??"GET"),prefixUrl:String(s.prefixUrl||""),retry:M(s.retry),throwHttpErrors:s.throwHttpErrors!==!1,timeout:s.timeout??1e4,fetch:s.fetch??globalThis.fetch.bind(globalThis)},typeof this._input!="string"&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw new TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&typeof this._input=="string"){if(this._input.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(x){this.abortController=new globalThis.AbortController;const o=this._options.signal??this._input.signal;o?.aborted&&this.abortController.abort(o?.reason),o?.addEventListener("abort",()=>{this.abortController.abort(o.reason)}),this._options.signal=this.abortController.signal}if(C&&(this._options.duplex="half"),this._options.json!==void 0&&(this._options.body=this._options.stringifyJson?.(this._options.json)??JSON.stringify(this._options.json),this._options.headers.set("content-type",this._options.headers.get("content-type")??"application/json")),this.request=new globalThis.Request(this._input,this._options),this._options.searchParams){const r="?"+(typeof this._options.searchParams=="string"?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(this._options.searchParams).toString()),a=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,r);(N&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)&&!(this._options.headers&&this._options.headers["content-type"])&&this.request.headers.delete("content-type"),this.request=new globalThis.Request(new globalThis.Request(a,{...this.request}),this._options)}}_calculateRetryDelay(t){if(this._retryCount++,this._retryCount>this._options.retry.limit||t instanceof P)throw t;if(t instanceof S){if(!this._options.retry.statusCodes.includes(t.response.status))throw t;const o=t.response.headers.get("Retry-After")??t.response.headers.get("RateLimit-Reset")??t.response.headers.get("X-RateLimit-Reset")??t.response.headers.get("X-Rate-Limit-Reset");if(o&&this._options.retry.afterStatusCodes.includes(t.response.status)){let r=Number(o)*1e3;Number.isNaN(r)?r=Date.parse(o)-Date.now():r>=Date.parse("2024-01-01")&&(r-=Date.now());const a=this._options.retry.maxRetryAfter??r;return r<a?r:a}if(t.response.status===413)throw t}const s=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,s)}_decorateResponse(t){return this._options.parseJson&&(t.json=async()=>this._options.parseJson(await t.text())),t}async _retry(t){try{return await t()}catch(s){const o=Math.min(this._calculateRetryDelay(s),b);if(this._retryCount<1)throw s;await F(o,{signal:this._options.signal});for(const r of this._options.hooks.beforeRetry)if(await r({request:this.request,options:this._options,error:s,retryCount:this._retryCount})===$)return;return this._retry(t)}}async _fetch(){for(const o of this._options.hooks.beforeRequest){const r=await o(this.request,this._options);if(r instanceof Request){this.request=r;break}if(r instanceof Response)return r}const t=J(this.request,this._options),s=this.request;return this.request=s.clone(),this._options.timeout===!1?this._options.fetch(s,t):B(s,t,this.abortController,this._options)}_stream(t,s){const o=Number(t.headers.get("content-length"))||0;let r=0;return t.status===204?(s&&s({percent:1,totalBytes:o,transferredBytes:r},new Uint8Array),new globalThis.Response(null,{status:t.status,statusText:t.statusText,headers:t.headers})):new globalThis.Response(new globalThis.ReadableStream({async start(a){const i=t.body.getReader();s&&s({percent:0,transferredBytes:0,totalBytes:o},new Uint8Array);async function n(){const{done:u,value:c}=await i.read();if(u){a.close();return}if(s){r+=c.byteLength;const h=o===0?0:r/o;s({percent:h,transferredBytes:r,totalBytes:o},c)}a.enqueue(c),await n()}await n()}}),{status:t.status,statusText:t.statusText,headers:t.headers})}}/*! MIT License Â© Sindre Sorhus */const w=e=>{const t=(s,o)=>y.create(s,f(e,o));for(const s of v)t[s]=(o,r)=>y.create(o,f(e,r,{method:s}));return t.create=s=>w(f(s)),t.extend=s=>(typeof s=="function"&&(s=s(e??{})),w(f(e,s))),t.stop=$,t},l=w(),z="false",R="https://sepiasearch.org",G=e=>{switch(e){case"today":return new Date(Date.now()-864e5).toISOString();case"week":return new Date(Date.now()-864e5*7).toISOString();case"month":return new Date(Date.now()-864e5*30).toISOString();case"year":return new Date(Date.now()-864e5*365).toISOString()}},W=e=>{switch(e){case"short":return[void 0,240];case"medium":return[240,600];case"long":return[600,void 0]}},X=async e=>{const s=e.pageInfo?.offset||0,o="/api/v1/search/video-playlists",r=new URL(`${R}${o}`);r.searchParams.append("search",e.query),r.searchParams.append("count","15"),r.searchParams.append("start",s.toString());const a=await l.get(r.toString()).json();return{items:a.data.map(n=>({name:n.displayName,apiId:`${n.ownerAccount.host}_${n.uuid}`,images:n.thumbnailUrl?[{url:n.thumbnailUrl}]:void 0})),pageInfo:{totalResults:a.total,resultsPerPage:15,offset:s}}},A=async e=>{const s=e.pageInfo?.offset||0,o="/api/v1/search/video-channels",r=new URL(`${R}${o}`);r.searchParams.append("search",e.query),r.searchParams.append("count","15"),r.searchParams.append("start",s.toString());const a=await l.get(r.toString()).json();return{items:a.data.map(n=>({name:n.name,apiId:`${n.name}@${n.host}`,images:n.avatar&&n.avatar.url?[{url:n.avatar.url}]:void 0})),pageInfo:{totalResults:a.total,resultsPerPage:15,offset:s}}},g=e=>{const t=`https://${e.channel.host}`,s=`${e.channel.name}@${e.channel.host}`;return{title:e.name,apiId:`${e.account.host}_${e.uuid}`,duration:e.duration,views:e.views,likes:e.likes,dislikes:e.dislikes,description:e.description,uploadDate:typeof e.createdAt=="string"?e.createdAt:e.createdAt.toISOString(),channelName:e.channel.displayName,channelApiId:s,images:[{url:`${t}${e.thumbnailPath}`}]}},q=async e=>{const s=e.pageInfo?.offset||0,o="/api/v1/search/videos",r=new URL(`${R}${o}`);r.searchParams.append("search",e.query),r.searchParams.append("count","15"),r.searchParams.append("start",s.toString()),r.searchParams.append("nsfw",z.toString()),e.filterInfo?.filters?e.filterInfo.filters.forEach(c=>{switch(c.id){case"startDate":const h=G(c.value);h&&r.searchParams.append("startDate",h);break;case"duration":const p=W(c.value);p&&(p[0]&&r.searchParams.append("durationMin",p[0].toString()),p[1]&&r.searchParams.append("durationMax",p[1].toString()));break;case"sort":r.searchParams.append("sort",c.value||"-match");break}}):r.searchParams.append("sort","-match");const a={filters:[{id:"sort",type:"select",displayName:"Sort by",value:"-match",options:[{displayName:"Best match",value:"-match"},{displayName:"Most recent",value:"-publishedAt"},{displayName:"Least recent",value:"publishedAt"}]},{id:"startDate",type:"radio",displayName:"Published Date",value:"",options:[{displayName:"Any",value:""},{displayName:"Last 24 Hours",value:"today"},{displayName:"Last 7 days",value:"week"},{displayName:"Last 30 days",value:"month"},{displayName:"Last 365 days",value:"year"}]},{id:"duration",type:"radio",displayName:"Duration",value:"",options:[{displayName:"Any",value:""},{displayName:"Short (< 4 min)",value:"short"},{displayName:"Medium (4-10 min)",value:"medium"},{displayName:"Long (> 10 min)",value:"long"}]}]},i=await l.get(r.toString()).json();return{items:i.data.map(g),pageInfo:{totalResults:i.total,resultsPerPage:15,offset:s},filterInfo:a}},Y=async e=>{const t=q(e),s=A(e),o=X(e),[r,a,i]=await Promise.all([t,s,o]);return{videos:r,channels:a,playlists:i}};application.onUiMessage=async e=>{switch(e.type){case"endvideo":application.endVideo();break}};const K=async e=>{const[t,s]=e.apiId.split("_"),o=`/api/v1/videos/${s}`,r=`https://${t}${o}`,a=await l.get(r).json();return g(a)},Q=async e=>{const t=e.pageInfo?.offset||0,s=15,o=e.apiId||"",[r,a]=o.split("@"),i=`/api/v1/video-channels/${e.apiId}/videos`,n=new URL(`https://${a}${i}`);n.searchParams.append("count",s.toString()),n.searchParams.append("start",t.toString());const u=await l.get(n.toString()).json();return{items:u.data.map(g),pageInfo:{totalResults:u.total,resultsPerPage:s,offset:t}}},Z=async e=>{const t=e.pageInfo?.offset||0,s=15,o=e.apiId||"",[r,a]=o.split("_"),i=`/api/v1/video-playlists/${a}/videos`,n=new URL(`https://${r}${i}`);n.searchParams.append("count",s.toString()),n.searchParams.append("start",t.toString());const u=await l.get(n.toString()).json();return{items:u.data.map(h=>h.video).filter(h=>!!h).map(g),pageInfo:{totalResults:u.total,resultsPerPage:s,offset:t}}};application.onSearchAll=Y;application.onSearchVideos=q;application.onSearchChannels=A;application.onGetChannelVideos=Q;application.onGetPlaylistVideos=Z;application.onGetVideo=K;
